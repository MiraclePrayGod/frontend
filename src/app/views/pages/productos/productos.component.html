<div class="container" [class.form-active]="mostrarAgregar || mostrarEditar">
  <h2 class="title">ğŸ›’ GestiÃ³n de Productos <span class="badge">{{productosFiltrados().length}} productos</span></h2>

  <div class="top-bar">
    <div class="search-container">
      <input type="text" [(ngModel)]="filtro" placeholder="ğŸ” Buscar producto..." class="search-input" />
      <span class="search-hint">Filtrando por: {{filtro || 'ningÃºn criterio'}}</span>
    </div>

    <button *ngIf="!mostrarAgregar && !mostrarEditar"
            (click)="mostrarAgregar = true; limpiarNuevoProducto(); productoSeleccionado = null;"
            class="add-button pulse-animation">
      â• Nuevo Producto
    </button>
  </div>

  <div class="card-container" *ngIf="!mostrarAgregar && !mostrarEditar; else formView">
    <div class="product-card" *ngFor="let producto of productosFiltrados()"
         [class.highlight]="producto.stock < 5" [class.new]=" (producto)">
      <div class="card-header">
        <h3>{{ producto.nombre }}</h3>
        <span class="price-tag">S/ {{ producto.precioUnitario | number:'1.2-2' }}</span>
      </div>

      <div class="image-container">
        <img [src]="producto.imagenUrl || placeholderImg" alt="{{ producto.nombre }}"
             (error)="producto.imagenUrl = placeholderImg" />
        <span class="stock-badge" [class.low-stock]="producto.stock < 5">
              {{ producto.stock }} en stock
            </span>
      </div>

      <div class="card-details">
        <p><strong class="detail-label">CategorÃ­a:</strong> {{ producto.categoria || 'Sin categorÃ­a' }}</p>
        <p class="description"><strong class="detail-label">DescripciÃ³n:</strong> {{ producto.descripcion || 'Sin descripciÃ³n' }}</p>
        <p><strong class="detail-label">Estado:</strong>
          <span [class.activo]="producto.estado" [class.inactivo]="!producto.estado">
                {{ producto.estado ? 'Activo âœ…' : 'Inactivo âŒ' }}
              </span>
        </p>
        <p class="creation-date"><strong class="detail-label">Creado:</strong> {{ producto.fechaCreacion | date:'mediumDate' }}</p>
      </div>

      <div class="card-buttons">
        <button class="edit-btn" (click)="editarProducto(producto)">
          <span class="icon">âœï¸</span> Editar
        </button>
        <button class="delete-btn" (click)="eliminarProducto(producto.id!)">
          <span class="icon">ğŸ—‘ï¸</span> Eliminar
        </button>
      </div>
    </div>

    <div class="empty-state" *ngIf="productosFiltrados().length === 0">
      <p>No se encontraron productos</p>
      <button (click)="mostrarAgregar = true; limpiarNuevoProducto()" class="add-button">
        â• Crear primer producto
      </button>
    </div>
  </div>

  <ng-template #formView>
    <div class="form-container slide-in">
      <form (ngSubmit)="mostrarAgregar ? agregarProducto() : guardarProducto()" #form="ngForm">
        <h3>{{ mostrarAgregar ? 'â• Agregar Producto' : 'âœï¸ Editar Producto' }}</h3>

        <div class="form-grid">
          <label class="form-group">
            <span class="form-label">Nombre</span>
            <input [(ngModel)]="(mostrarAgregar ? nuevoProducto : productoSeleccionado)!.nombre"
                   name="nombre" type="text" required #ctrlNombre="ngModel"
                   [class.invalid]="ctrlNombre.invalid && ctrlNombre.touched" />
            <span *ngIf="ctrlNombre.invalid && ctrlNombre.touched" class="error-message">âš ï¸ Campo requerido</span>
          </label>

          <label class="form-group">
            <span class="form-label">CategorÃ­a</span>
            <input [(ngModel)]="(mostrarAgregar ? nuevoProducto : productoSeleccionado)!.categoria"
                   name="categoria" type="text" />
          </label>

          <label class="form-group span-2">
            <span class="form-label">DescripciÃ³n</span>
            <textarea [(ngModel)]="(mostrarAgregar ? nuevoProducto : productoSeleccionado)!.descripcion"
                      name="descripcion" rows="3"></textarea>
          </label>

          <label class="form-group">
            <span class="form-label">Precio Unitario (S/)</span>
            <input [(ngModel)]="(mostrarAgregar ? nuevoProducto : productoSeleccionado)!.precioUnitario"
                   name="precioUnitario" type="number" step="0.01" required #ctrlPrecio="ngModel"
                   [class.invalid]="ctrlPrecio.invalid && ctrlPrecio.touched" />
            <span *ngIf="ctrlPrecio.invalid && ctrlPrecio.touched" class="error-message">âš ï¸ Precio invÃ¡lido</span>
          </label>

          <label class="form-group">
            <span class="form-label">Stock</span>
            <input [(ngModel)]="(mostrarAgregar ? nuevoProducto : productoSeleccionado)!.stock"
                   name="stock" type="number" required #ctrlStock="ngModel"
                   [class.invalid]="ctrlStock.invalid && ctrlStock.touched" />
            <span *ngIf="ctrlStock.invalid && ctrlStock.touched" class="error-message">âš ï¸ Stock invÃ¡lido</span>
          </label>

          <label class="form-group span-2">
            <span class="form-label">URL Imagen</span>
            <input [(ngModel)]="(mostrarAgregar ? nuevoProducto : productoSeleccionado)!.imagenUrl"
                   name="imagenUrl" type="url" />
            <span class="hint">Dejar vacÃ­o para usar imagen predeterminada</span>
          </label>

          <label class="form-group">
            <span class="form-label">Estado</span>
            <select [(ngModel)]="(mostrarAgregar ? nuevoProducto : productoSeleccionado)!.estado"
                    name="estado" required class="status-select">
              <option [ngValue]="true">ğŸŸ¢ Activo</option>
              <option [ngValue]="false">ğŸ”´ Inactivo</option>
            </select>
          </label>
        </div>

        <div class="form-actions">
          <button type="submit" [disabled]="form.invalid" class="submit-button">
            {{ mostrarAgregar ? 'ğŸ’¾ Registrar Producto' : 'ğŸ’¾ Guardar Cambios' }}
          </button>
          <button type="button" (click)="cancelarForm()" class="cancel-button">
            âŒ Cancelar
          </button>
        </div>
      </form>
    </div>
  </ng-template>
</div>
